apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod-with-secret
  labels:
    app: secret-volume-demo
spec:
  containers:
  - name: nginx
    image: nginx:1.21
    ports:
    - containerPort: 80
    - containerPort: 443
    
    # 볼륨 마운트 설정
    volumeMounts:
    # Secret을 파일로 마운트 (모든 키)
    - name: secret-volume
      mountPath: /etc/secrets
      readOnly: true
    
    # TLS 인증서를 특정 경로에 마운트
    - name: tls-volume
      mountPath: /etc/ssl/certs/server.crt
      subPath: tls.crt
      readOnly: true
    
    - name: tls-volume
      mountPath: /etc/ssl/private/server.key
      subPath: tls.key
      readOnly: true
    
    # API 키만 별도 파일로 마운트
    - name: api-key-volume
      mountPath: /etc/api/key
      subPath: api-key
      readOnly: true
    
    # 리소스 제한
    resources:
      requests:
        memory: "32Mi"
        cpu: "100m"
      limits:
        memory: "64Mi"
        cpu: "200m"
  
  # 볼륨 정의
  volumes:
  # 모든 Secret 키를 파일로 마운트
  - name: secret-volume
    secret:
      secretName: app-secret
      defaultMode: 0400  # 읽기 전용 (소유자만)
  
  # TLS 인증서용 Secret
  - name: tls-volume
    secret:
      secretName: my-tls-secret
      defaultMode: 0400
      items:
      - key: tls.crt
        path: tls.crt
      - key: tls.key
        path: tls.key
  
  # API 키만 선택적으로 마운트
  - name: api-key-volume
    secret:
      secretName: app-secret
      defaultMode: 0400
      items:
      - key: api-key
        path: api-key
  
  restartPolicy: Always
